game.states.TWN_Hospital_ZealousAssistant_003 = State { function()

    modules = { "shared.dialog", "shared.math" }

    params.operationPos = {
        type = EParamType.String,
        help = "The trigger at which the character stands while watching."
    }

    params.behaviorDialog = {
        type = EParamType.String,
    }

    params.behaviorTrigger = {
        type = EParamType.String,
    }

    local fl_SurgeonIsDead = Flag("TWN_Hospital_State_SurgeonDead_0820e94c-7007-4459-b935-2d33fbbf6aa9")
    local fl_SurgeonWasKilledByNurses = Flag("TWN_Hospital_State_NursesKilledSurgeon_dc371af2-0788-43f9-990f-aaaf2192f8ca")
    local fl_PatientReleased = Flag("TWN_Hospital_State_PatientReleased_2d47b88f-3c8e-4f74-8833-6934c7a6b70d")
    local fl_PatientDead = Flag("TWN_Hospital_State_PatientDead_482ffbdd-4df2-4d1f-af76-e46ffdd2bdfc")
    local fl_HostileResolution = Flag("TWN_Hospital_State_HostileResolution_b183f1f4-2935-4995-a9df-5731c0f65cf3")
    local fl_OperationParticipantDied = Flag("TWN_Hospital_State_OperationParticipantDied_a8a7c54f-5cbc-4270-b368-77a3b322885d")

    local patrolPos000 = Entity("S_TWN_Hospital_ZealousAssistant_003_PatrolPoint_000_c9fe9838-db12-4843-b27b-9b4428408c6d")
    local patrolPos001 = Entity("S_TWN_Hospital_ZealousAssistant_003_PatrolPoint_001_9551b8ab-2e5c-44fe-8a17-9d6a60e14df4")
    local patrolPos002 = Entity("S_TWN_Hospital_ZealousAssistant_003_PatrolPoint_002_8465aead-4ece-4808-b980-2fe10b2eae8b")

    local anim_ListeningToSurgeon = Animation("CUST_AccusingInCourt_01_Loop_82f29123-5574-4620-9c4d-f02055d6cfe7")

    local operationPos = Entity(params.operationPos)
    local b_LoopingAnim = false
    local dlg_AD = Dialog("TWN_Hospital_ZealousAssistant_003_AD_abbb5b4e-52e9-a0f7-e006-bdc1fb82bdb4")

    -- Operation if default = stand at trigger, playing assisting animation
    -- Look for Criminal if scene interrupted - look for the criminal; - fl_SceneInterrupted
    -- Look for Criminal if player killed the master - look for the criminal; fl_SurgeonIsDead and not fl_NursesKilled
    -- if the nurses killed the master - custom behavior; fl_NurseKilled
    -- if the last nurse survived - custom behavior;
    -- Operation
    -- Patrol
    -- Custom Behavior
    nodes.UniqueBehavior = Action {
        function()
            DebugText(me, "CustomBehavior")
            MoveTo(patrolPos000, MovementSpeed.Walk)
            LookFrom(patrolPos000)
            Sleep(mod.math.random(3, 9))
            MoveTo(patrolPos001, MovementSpeed.Walk)
            LookFrom(patrolPos001)
            Sleep(mod.math.random(3, 9))
            try
                mod.dialog.StartCheckedAutomatedDialogRateLimited(
                    dlg_AD,
                    {
                        minDelay = 10.0,
                        cullingDistance = 10.0,
                        waitForCompletion = false
                    },
                    me)
            catch e if ls.CheckType(e, error.AutomatedDialogStartFailed) then
                --
            end
            MoveTo(patrolPos002, MovementSpeed.Walk)
            LookFrom(patrolPos002)
            Sleep(mod.math.random(3, 9))
        end,
        CanEnter = function()
            return GetFlag(fl_SurgeonIsDead, nil)
        end,
    }

    nodes.PatrolBehavior = Action {
        function()
            DebugText(me, "Patrol")
            MoveTo(patrolPos000, MovementSpeed.Walk)
            LookFrom(patrolPos000)
            Sleep(mod.math.random(3, 9))
            MoveTo(patrolPos001, MovementSpeed.Walk)
            LookFrom(patrolPos001)
            Sleep(mod.math.random(3, 9))
            try
                mod.dialog.StartCheckedAutomatedDialogRateLimited(
                    dlg_AD,
                    {
                        minDelay = 10.0,
                        cullingDistance = 10.0,
                        waitForCompletion = false
                    },
                    me)
            catch e if ls.CheckType(e, error.AutomatedDialogStartFailed) then
                --
            end
            MoveTo(patrolPos002, MovementSpeed.Walk)
            LookFrom(patrolPos002)
            Sleep(mod.math.random(3, 9))
        end,
        CanEnter = function()
            return GetFlag(fl_OperationParticipantDied, nil) or GetFlag(fl_PatientReleased)
        end
    }

    nodes.OperationBehavior = Proxy {
        game.states.TWN_Hospital_ZealousAssistant_Operation,
        params = {
            operationPos = params.operationPos,
            behaviorDialog = params.behaviorDialog,
            behaviorTrigger = params.behaviorTrigger,
        },
    }

end}